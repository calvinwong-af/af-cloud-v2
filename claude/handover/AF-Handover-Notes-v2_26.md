# Handover Notes â€” v2.26\n**Date:** 01 March 2026\n**Session type:** Bug Fixes + Analysis + Migration Prompt Preparation\n\n---\n\n## Session Summary\n\nLong analysis-heavy session. Fixed several small UI bugs, confirmed EP series tests as passed, did deep analysis on V1 to V2 migration strategy, confirmed collision-free prefix re-key plan, and prepared the full migration prompt for Opus.\n\n---\n\n## Fixes Applied This Session\n\n### 1. Status Icon Swap (Booking Confirmed / Departed)\n**Problem:** Icons were semantically backwards. Departed (4001) showed a navigation arrow while Booking Confirmed (3002) showed a ship. The ship should represent the vessel actually sailing, not just paperwork confirmed.\n\n**Fix:**\n- 3002 Booking Confirmed: Stamp icon (paperwork stamped)\n- 4001 Departed: Ship icon (vessel at sea), Plane for AIR\n\n**File:** `af-platform/src/components/shipments/ShipmentOrderTable.tsx`\n\n---\n\n### 2. Tab Label: Pending Invoice to To Invoice\n**Problem:** The shipments page tab was labelled Pending Invoice while the dashboard KPI card and all other references said To Invoice.\n\n**Fix:** Single string change in FILTER_TABS array.\n\n**File:** `af-platform/src/app/(platform)/shipments/page.tsx`\n\n---\n\n### 3. Python 3.14 Compatibility - venv enforcement\n**Problem:** System Python is 3.14 which is incompatible with google-cloud-datastore (protobuf C extension fails with TypeError: Metaclasses with custom tp_new).\n\n**Fix:**\n- Added `af-server/.python-version` file pinned to 3.11\n- Updated CLAUDE.md with prominent warning and explicit examples for scripts/one-liners/pip using `.venv\\Scripts\\python`\n\n**Files:** `af-server/.python-version` (new), `CLAUDE.md`\n\n---\n\n## Test Status Updates\n\n### EP Series - All Passed\nEP-01 through EP-05 (Edit Parties clear/null semantics) confirmed working by user. All marked PASSED in handover v2.25.\n\n---\n\n## Migration Analysis - V1 to V2 Full Normalisation\n\n### Decision Made\nFull migration of all 3,851 AFCQ- records to V2 format with AF- prefix re-key.\n\n**Key decisions:**\n- Prefix swap: AFCQ-XXXXXX to AF-XXXXXX (same numeric index)\n- migrated_from_v1: True flag preserved on all migrated records\n- Old V1 Kinds (ShipmentOrder, QuotationFreight, etc.) left untouched as archive\n- Active shipments (23) migrate alongside historical ones\n- ShipmentWorkFlow and Files Kinds re-keyed to AF- IDs\n- ShipmentOrderV2CountId registered for all migrated IDs\n\n### Collision Check - Confirmed Clean\n- AFCQ- range: 000001 to 003864\n- Existing AF- records: 003865, 003866, 003867\n- No overlap - clean boundary\n\n### Performance Impact Assessment\n- List queries: most significant gain (single Kind query vs multi-Kind merge)\n- Shipment detail: half the Datastore round trips\n- Stats endpoint: single loop instead of three\n- Real value is maintainability and correctness, not raw speed at current scale\n\n---\n\n## Active Prompt - In Progress\n\n**File:** `claude/prompts/PROMPT-CURRENT.md`\n\n**3 Tasks for Opus:**\n\n1. Rewrite `af-server/scripts/migrate_v1_to_v2.py` - full rewrite with pre-flight collision check, inline issued_invoice OR-logic resolution, full field assembly from all V1 Kinds, prefix re-key AFCQ- to AF-, ShipmentWorkFlow re-key, Files Kind update, ShipmentOrderV2CountId registration, dry-run / --commit / --only flags, idempotent.\n\n2. Fix is_v1 detection in write endpoints - change startswith(AFCQ-) to data_version < 2 entity check across all write endpoints in shipments.py. Add AFCQ- to AF- fallback in get_shipment.\n\n3. Deprecate V1 constants in constants.py - mark with comments, do not delete yet.\n\n---\n\n## Backlog - Post-Migration\n\nOnce the migration prompt is executed and validated:\n\n- Platform cleanup: Remove v1-assembly.ts read path, assembleV1ShipmentOrder, V1 branching in shipments.ts\n- Server cleanup: Remove V1 branches from list_shipments, get_shipment, get_shipment_stats, search\n- OF series: No longer needed once migration is done\n- PT series: Port terminal migration scripts still pending execution\n\n---\n\n## Test Items Added This Session\n\n| # | Test | Status |\n|---|---|---|\n| MI-01 | --only AFCQ-003829 dry run - correct V2 record assembled, no errors | PENDING |\n| MI-02 | Full dry run - 3,851 records, 0 assembly errors | PENDING |\n| MI-03 | Live run - sample 3 migrated records readable in platform | PENDING |\n| MI-04 | Status writes on migrated records use data_version check not prefix | PENDING |\n| MI-05 | Stale AFCQ- URL in browser resolves to AF- record | PENDING |\n\n---\n\n## Next Session - Recommended Starting Point\n\n1. Opus delivers migration script and write endpoint fixes\n2. Run --only AFCQ-003829 dry run to validate assembly\n3. Run full dry run and review report for errors\n4. Commit run when clean\n5. Spot-check 3 migrated records in platform (active, completed, cancelled)\n6. Prepare platform cleanup prompt once migration is confirmed stable\n